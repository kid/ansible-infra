---

- hosts: need_ansible_prep
  gather_facts: false
  tasks:
    - set_fact:
        ansible_ssh_user: root
        ansible_remote_tmp: /tmp/.root

    - apt:
        update_cache: true
        name:
          - sudo
          - python3

    - name: Add user "ansible" to sudo
      lineinfile:
        path: /etc/sudoers.d/ansible
        line: 'ansible ALL=(ALL) NOPASSWD: ALL'
        state: present
        mode: 0440
        create: true
        validate: 'visudo -cf %s'

    - user:
        name: ansible
        uid: 1100
        password_lock: true
        shell: /bin/bash

    - ansible.posix.authorized_key:
        user: ansible
        state: present
        key: https://github.com/kid.keys

    - set_fact:
        ansible_ssh_user: ansible
        ansible_remote_tmp: /tmp/.ansible
