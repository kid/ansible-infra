---

- name: get download client schema
  uri:
    url: "{{ api_url }}/downloadclient/schema"
    return_content: true
    headers:
      X-Api-Key: "{{ api_key }}"
  register: _schema

- set_fact:
    body: "{{ body | default({}) | combine({ item.key: item.value }) }}"
  with_dict: "{{ _schema.json | selectattr('implementation', 'match', '(?i)^sabnzbd$') | first }}"
  when: item.key not in ['id', 'fields']

- set_fact:
    _fields: "{{ _schema.json | selectattr('implementation', 'match', '(?i)^sabnzbd$') | map(attribute='fields') | first }}"

- set_fact:
    fields: >-
      {%- set fields = [] -%}
      {%- for item in _fields -%}
      {%-   if item.name in overrides -%}
      {%-     do fields.append({ 'name': item.name, 'value': overrides[item.name] }) -%}
      {%-   elif item.label == 'Category' -%}
      {%-     do fields.append({ 'name': item.name, 'value': sabnzbd_category }) -%}
      {%-   else -%}
      {%-     do fields.append({ 'name': item.name }) -%}
      {%-   endif -%}
      {%- endfor -%}
      {{ fields }}
  vars:
    overrides:
      host: "{{ hostvars['sabnzbd']['sabnzbd_host'] }}"
      port: "{{ hostvars['sabnzbd']['sabnzbd_port'] }}"
      apiKey: "{{ hostvars['sabnzbd']['sabnzbd_api_key'] }}"
      useSsl: "{{ hostvars['sabnzbd']['sabnzbd_use_ssl'] }}"

- name: get download clients
  uri:
    url: "{{ api_url }}/downloadclient"
    return_content: true
    headers:
      X-Api-Key: "{{ api_key }}"
  register: _download_clients

- name: add sabnzbd download client
  uri:
    url: "{{ api_url }}/downloadclient"
    method: POST
    body_format: json
    body: "{{ body | combine({ 'name': 'sabnzbd', 'enable': true, 'fields': fields }) }}"
    headers:
      X-Api-Key: "{{ api_key }}"
    status_code: 201
  when: "'sabnzbd' not in _download_clients.json | default([], true) | map(attribute='name')"

- set_fact:
    _sabnzbd_data: "{{ _download_clients.json | selectattr('name', 'equalto', 'sabnzbd') | first }}"
  when: "'sabnzbd' in _download_clients.json | default([], true) | map(attribute='name')"

- name: update sabnzbd download client
  uri:
    url: "{{ api_url }}/downloadclient/{{ _download_clients.json | selectattr('name', 'equalto', 'sabnzbd') | map(attribute='id') | first }}"
    method: PUT
    body_format: json
    body: "{{ body | combine({ 'name': 'sabnzbd', 'enable: true, 'fields': fields, 'id': sabnzbd.id }) }}"
    headers:
      X-Api-Key: "{{ api_key }}"
    status_code: 201
  when:
    - _sabnzbd is defined
    - (_sabnzbd.data | selectattr('name', 'equalto', 'host') | map(attribute='value') | first) != hostvars['sabnzbd']['sabnzbd_host'] or
      (_sabnzbd.data | selectattr('name', 'equalto', 'port') | map(attribute='value') | first) != hostvars['sabnzbd']['sabnzbd_port'] or
      (_sabnzbd.data | selectattr('name', 'equalto', 'apiKey') | map(attribute='value') | first) != hostvars['sabnzbd']['sabnzbd_api_key'] or
      (_sabnzbd.data | selectattr('name', 'equalto', 'useSsl') | map(attribute='value') | first) != hostvars['sabnzbd']['sabnzbd_use_ssl'] or
      (_sabnzbd.data | selectattr('name', 'equalto', 'category') | map(attribute='value') | first) != sabnzbd_category
